:type: service
:name: HashiCorp Consul
:icon: /_docs/consul.png
:description: Deploy a Consul cluster. Supports automatic bootstrapping, DNS, Consul UI, and auto healing.
:category: Service discovery, service mesh
:cloud: google
:tags: consul, iam
:license: gruntwork
:built-with: terraform

// AsciiDoc TOC settings
:toc:
:toc-placement!:
:toc-title:

// GitHub specific settings. See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74 for details.
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]



image:https://img.shields.io/badge/maintained%20by-gruntwork.io-%235849a6.svg[link="https://gruntwork.io/?ref=repo_gcp_consul"]

= Consul for Google Cloud Platform (GCP)

This repo contains a Terraform Module for how to deploy a link:https://www.consul.io/[Consul] cluster on
link:https://cloud.google.com/[GCP] using link:https://www.terraform.io/[Terraform]. Consul is a distributed, highly-available
tool that you can use for service discovery and key/value storage. A Consul cluster typically includes a small number
of server nodes, which are responsible for being part of the link:https://www.consul.io/docs/internals/consensus.html[consensus quorum], and a larger number of client nodes, which you typically run alongside your apps:

image::_docs/architecture.png?raw=true[Terraform AWS  Consul]

toc::[]


== Features

* link:/modules/install-consul[install-consul]: This module installs Consul using a link:https://www.packer.io/[Packer]
  template to create a Consul lik:https://cloud.google.com/compute/docs/images[Custom Image].

* link:/modules/consul-cluster[consul-cluster]: The module includes Terraform code to deploy a Consul Image across a link:https://cloud.google.com/compute/docs/instance-groups/[Managed Compute Instance Group].

* link:/modules/run-consul[run-consul]: This module includes the scripts to configure and run Consul. It is used
  by the above Packer module at build-time to set configurations, and by the Terraform module at runtime
  with the Instance's link:https://cloud.google.com/compute/docs/startupscript[Startup Script] to create the cluster.

* link:/modules/install-dnsmasq[install-dnsmasq module]: Install linkhttp://www.thekelleys.org.uk/dnsmasq/doc.html[Dnsmasq]
  and configure it to forward requests for a specific domain to Consul. This allows you to use Consul as a DNS server
  for URLs such as `foo.service.consul`.



== Learn

NOTE: This repo is a part of link:https://github.com/hashicorp[Hashicorp], a collection of reusable, battle-tested, production ready infrastructure code.

=== Core concepts

* link:https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html[Learn about Amazon Machine Images(AMI's)].
* link:https://aws.amazon.com/autoscaling/[What is auto scaling]?
* link:https://gruntwork.io/guides/kubernetes/deploying-a-dockerized-app-on-gcp-gke/[Deploy a dockerized application]

=== Repo organization

* link:(/modules)[modules]: This folder contains the reusable code for this Module, broken down into one or more submodules.
* link:/examples[examples]: This folder contains examples of how to use the submodules.
* link:/test[test]: Automated tests for the submodules and examples.


== Deploy

==== Deploy Consul Servers

1. Create a Consul Image using a Packer template that references the link:/modules/install-consul[install-consul module].
   Here is an link:/examples/consul-image#quick-start[example Packer template]. Note that Google Cloud does not support custom
   public Images so you must build this Packer template on your own to proceed.

1. Deploy that Image across a Compute Instance Group using the Terraform link:/modules/consul-cluster[consul-cluster module]
   and execute the link:/modules/run-consul[run-consul script] with the `--server` flag during boot on each
   Instance in the Compute Instance Group to form the Consul cluster. Here is link:/examples/root-example#quick-start[an example Terraform configuration] to provision a Consul cluster.

==== Deploy Consul Clients

1. Use the link:/modules/install-consul[install-consul module] to install Consul alongside your application code.
1. Before booting your app, execute the link:/modules/run-consul[run-consul script] with `--client` flag.
1. Your app can now usr the local Consul agent for service discovery and key/value storage.
1. Optionally, you can use the link:/modules/install-dnsmasq[install-dnsmasq module] to configure Consul as the DNS for a
   specific domain (e.g. `.consul`) so that URLs such as `foo.service.consul` resolve automatically to the IP
   address(es) for a service `foo` registered in Consul (all other domain names will be continue to resolve using the
   default resolver on the OS).


=== Who maintains this Terraform Module?

This Terraform Module is maintained by link:http://www.gruntwork.io/[Gruntwork]. If you're looking for help or commercial
support, send an email to link:mailto:modules@gruntwork.io?Subject=Consul%20Terraform%20Module[modules@gruntwork.io].
Gruntwork can help with:

* Setup, customization, and support for this Terraform Module.
* Terraform Module for other types of Google Cloud infrastructure.
* Terraform Modules that meet compliance requirements, such as HIPAA.
* Consulting & Training on Google Cloud, AWS, Terraform, and DevOps.

=== How do I contribute to this Module?

Contributions are very welcome! Check out the link:/CONTRIBUTING.md[Contribution Guidelines] for instructions.



=== How is this Module versioned?

This Module follows the principles of link:http://semver.org/[Semantic Versioning]. You can find each new release, 
along with the changelog, in the link:../../releases[Releases Page]. 

During initial development, the major version will be 0 (e.g., `0.x.y`), which indicates the code does not yet have a 
stable API. Once we hit `1.0.0`, we will make every effort to maintain a backwards compatible API and use the MAJOR, 
MINOR, and PATCH versions on each release to indicate any incompatibilities. 



== License

This code is released under the Apache 2.0 License. Please see link:/LICENSE[LICENSE] and link:/NOTICE[NOTICE] for more 
details.

Copyright &copy; 2017 Gruntwork, Inc.